# ============================================
# Prueba escalonada completa
# Login + consultas + toma de ramos + pagos
# Contra API Gateway UTF (Ingress: api.utf.local)
# ============================================

settings:
  env:
    BASE_URL: http://api.utf.local
  # Opcional: timeouts algo más altos
  http:
    timeout: 30s

execution:
  # ============================
  # TRAMO 1: 100 usuarios
  # ============================
  - concurrency: 100
    ramp-up: 30s
    hold-for: 2m
    scenario: flujo-completo-toma-ramos

  # ============================
  # TRAMO 2: 300 usuarios
  # ============================
  - concurrency: 300
    ramp-up: 45s
    hold-for: 3m
    scenario: flujo-completo-toma-ramos

  # ============================
  # TRAMO 3: 500 usuarios
  # ============================
  - concurrency: 500
    ramp-up: 1m
    hold-for: 3m
    scenario: flujo-completo-toma-ramos

  # ============================
  # TRAMO 4: 1000 usuarios
  # ============================
  - concurrency: 600
    ramp-up: 90s
    hold-for: 3m
    scenario: flujo-completo-toma-ramos

  # ============================
  # TRAMO 5: 3000 usuarios
  # ============================
  - concurrency: 800
    ramp-up: 2m
    hold-for: 3m
    scenario: flujo-completo-toma-ramos

  # ============================
  # TRAMO 6: 5000 usuarios
  # ============================
  - concurrency: 1000
    ramp-up: 3m
    hold-for: 3m
    scenario: flujo-completo-toma-ramos

  # ============================
  # TRAMO 7: 10000 usuarios
  # ============================
  - concurrency: 1300
    ramp-up: 4m
    hold-for: 3m
    scenario: flujo-completo-toma-ramos


scenarios:
  flujo-completo-toma-ramos:
    think-time: 0.3s

    requests:

      # ===============================================
      # 1) LOGIN
      # ===============================================
      - label: login-email
        url: ${BASE_URL}/auth
        method: POST
        headers:
          Content-Type: application/json
        body: |
          {
            "email": "user@email.com",
            "password": "12345"
          }
        extract-jsonpath:
          token:
            jsonpath: $.token
          user_uuid:
            jsonpath: $.user.uuid

      # ===============================================
      # 2) INSCRIPCIÓN – Asignaturas disponibles
      #    Además extraemos una sección con cupos
      #    para usarla en la toma de ramos
      # ===============================================
      - label: ver-asignaturas
        url: ${BASE_URL}/inscripcion/asignaturas
        method: GET
        headers:
          Authorization: "Bearer ${token}"
        extract-jsonpath:
          # Tomamos la primera seccion del primer elemento
          # del array. Si falla, usamos default 4.
          seccion_id:
            jsonpath: $[0].secciones[0].id
            default: 4

      
      # ===============================================
      # 4) INSCRIPCIÓN – Asignaturas inscritas del alumno
      # ===============================================
      - label: ver-inscripciones-alumno
        url: ${BASE_URL}/inscripcion/alumnos/${user_uuid}/asignaturas
        method: GET
        headers:
          Authorization: "Bearer ${token}"

      # ===============================================
      # 5) INSCRIPCIÓN – Estado académico del alumno
      # ===============================================
      - label: estado-alumno-inscripcion
        url: ${BASE_URL}/inscripcion/alumno-estado/${user_uuid}
        method: GET
        headers:
          Authorization: "Bearer ${token}"

      # ===============================================
      # 6) PAGO – Estado financiero
      # ===============================================
      - label: estado-pago
        url: ${BASE_URL}/pago/estado/${user_uuid}
        method: GET
        headers:
          Authorization: "Bearer ${token}"

      # ===============================================
      # 7) PAGO – Pago de matrícula
      # ===============================================
      - label: pagar-matricula
        url: ${BASE_URL}/pago/pagar-matricula
        method: POST
        headers:
          Content-Type: application/json
          Authorization: "Bearer ${token}"
        body: |
          {
            "uuid": "${user_uuid}"
          }
