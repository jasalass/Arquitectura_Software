# HA Postgres (primary + replica) con Pgpool y backup diario
# Usa imágenes compatibles hospedadas en GHCR (bitnami-compat).
# Probado con Docker Desktop en Windows.

networks:
  utf_net:
    external: true

volumes:
  pg1_data:
  pg2_data:
  pgbackups:

services:
  pg-primary:
    image: ghcr.io/zcube/bitnami-compat/postgresql-repmgr:15
    container_name: pg-primary-1
    hostname: pg-primary-1
    restart: unless-stopped
    environment:
      POSTGRESQL_POSTGRES_PASSWORD: supersecret_root
      POSTGRESQL_USERNAME: appuser
      POSTGRESQL_PASSWORD: appsecret
      POSTGRESQL_DATABASE: inscripciones

      REPMGR_PASSWORD: repmgrpass
      REPMGR_NODE_ID: 1
      REPMGR_NODE_NAME: pg-primary-1
      REPMGR_NODE_NETWORK_NAME: pg-primary-1
      REPMGR_PRIMARY_HOST: pg-primary-1
      REPMGR_PARTNER_NODES: pg-primary-1,pg-replica-2
      REPMGR_PRIMARY_ROLE_WAIT_FOR_NODE: pg-primary-1
      REPMGR_PRIMARY_PORT: 5432
    ports:
      - "5434:5432"
    volumes:
      - pg1_data:/bitnami/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U appuser -d inscripciones -h 127.0.0.1"]
      interval: 10s
      timeout: 5s
      retries: 20
    networks:
      - utf_net

  pg-replica:
    image: ghcr.io/zcube/bitnami-compat/postgresql-repmgr:15
    container_name: pg-replica-2
    hostname: pg-replica-2
    restart: unless-stopped
    environment:
      # superusuario postgres (igual al primario)
      POSTGRESQL_POSTGRES_PASSWORD: supersecret_root

      # ➜ AÑADE TAMBIÉN ESTAS (igual que en el primario)
      POSTGRESQL_USERNAME: appuser
      POSTGRESQL_PASSWORD: appsecret

      # repmgr
      REPMGR_PASSWORD: repmgrpass
      REPMGR_NODE_ID: 2
      REPMGR_NODE_NAME: pg-replica-2
      REPMGR_NODE_NETWORK_NAME: pg-replica-2
      REPMGR_PRIMARY_HOST: pg-primary-1
      REPMGR_PARTNER_NODES: pg-primary-1,pg-replica-2
      REPMGR_PRIMARY_ROLE_WAIT_FOR_NODE: pg-primary-1

    depends_on:
      - pg-primary
    volumes:
      - pg2_data:/bitnami/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U appuser -d inscripciones -h 127.0.0.1"]
      interval: 10s
      timeout: 5s
      retries: 20
    networks:
      - utf_net

  pgpool:
    image: ghcr.io/zcube/bitnami-compat/pgpool:4
    container_name: pgpool
    hostname: pgpool
    restart: unless-stopped
    environment:
      PGPOOL_POSTGRES_USERNAME: postgres
      PGPOOL_POSTGRES_PASSWORD: supersecret_root
      PGPOOL_SR_CHECK_USER: postgres
      PGPOOL_SR_CHECK_PASSWORD: supersecret_root
      PGPOOL_ADMIN_USERNAME: admin
      PGPOOL_ADMIN_PASSWORD: adminpass
      # Usa los hostnames de arriba (deben resolver en la red):
      PGPOOL_BACKEND_NODES: 0:pg-primary-1:5432,1:pg-replica-2:5432
      PGPOOL_ENABLE_LOAD_BALANCING: "yes"
      PGPOOL_HEALTH_CHECK_ON: "1"
      PGPOOL_HEALTH_CHECK_PERIOD: "10"
      PGPOOL_HEALTH_CHECK_TIMEOUT: "5"
      PGPOOL_FAILOVER_ON_BACKEND_ERROR: "yes"
    ports:
      - "5433:5432"
    depends_on:
      pg-primary:
        condition: service_healthy
      pg-replica:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 5432 -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 20
    networks:
      - utf_net

  adminer:
    image: adminer:latest
    container_name: adminer-insc
    restart: unless-stopped
    environment:
      ADMINER_DEFAULT_SERVER: pgpool
    ports:
      - "8080:8080"
    depends_on:
      pgpool:
        condition: service_healthy
    networks:
      - utf_net

  pg-backup:
    image: postgres:15-alpine
    container_name: pg-backup
    restart: unless-stopped
    environment:
      PGPASSWORD: appsecret
    volumes:
      - pgbackups:/backups
    entrypoint: [ "sh", "-lc" ]
    command: |
      while true; do
        ts=$(date +%Y%m%d-%H%M%S);
        echo "Backup $ts";
        pg_dump -h pgpool -p 5432 -U appuser -F c -d inscripciones -f /backups/inscripciones-$ts.dump || true;
        sleep 86400;
      done
    depends_on:
      pgpool:
        condition: service_healthy
    networks:
      - utf_net
